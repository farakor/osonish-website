#!/bin/bash

################################################################################
# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Osonish Website –Ω–∞ production —Å–µ—Ä–≤–µ—Ä–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-update.sh
################################################################################

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
PROJECT_DIR="$(pwd)"
APP_NAME="osonish-website"
BACKUP_DIR="${PROJECT_DIR}/backups"
LOG_FILE="${PROJECT_DIR}/logs/deploy-$(date +%Y%m%d_%H%M%S).log"

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
mkdir -p "${BACKUP_DIR}"
mkdir -p "$(dirname ${LOG_FILE})"

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${2}${1}${NC}" | tee -a "${LOG_FILE}"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥—ã
check_status() {
    if [ $? -eq 0 ]; then
        log "‚úì $1" "${GREEN}"
    else
        log "‚úó $1 - –û–®–ò–ë–ö–ê!" "${RED}"
        exit 1
    fi
}

# –ó–∞–≥–æ–ª–æ–≤–æ–∫
echo "" | tee -a "${LOG_FILE}"
log "========================================" "${BLUE}"
log "üöÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Osonish Website" "${BLUE}"
log "========================================" "${BLUE}"
log "–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: $(date)" "${BLUE}"
log "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${PROJECT_DIR}" "${BLUE}"
echo "" | tee -a "${LOG_FILE}"

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "package.json" ]; then
    log "–û—à–∏–±–∫–∞: package.json –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ osonish-website" "${RED}"
    exit 1
fi

# 2. –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è .env —Ñ–∞–π–ª–∞
log "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..." "${YELLOW}"
if [ -f ".env.production" ]; then
    cp .env.production "${BACKUP_DIR}/.env.production.backup.$(date +%Y%m%d_%H%M%S)"
    check_status "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è .env —Å–æ–∑–¥–∞–Ω–∞"
else
    log "‚ö† –§–∞–π–ª .env.production –Ω–µ –Ω–∞–π–¥–µ–Ω" "${YELLOW}"
fi

# 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–º–º–∏—Ç–∞ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–∫–∞—Ç–∞
CURRENT_COMMIT=$(git rev-parse HEAD)
log "üìå –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: ${CURRENT_COMMIT}" "${BLUE}"

# 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git
log "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..." "${YELLOW}"
git fetch origin >> "${LOG_FILE}" 2>&1
check_status "Git fetch –≤—ã–ø–æ–ª–Ω–µ–Ω"

# –ü–æ–∫–∞–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
CHANGES=$(git log HEAD..origin/main --oneline 2>/dev/null)
if [ -n "$CHANGES" ]; then
    log "üìã –ù–æ–≤—ã–µ –∫–æ–º–º–∏—Ç—ã:" "${BLUE}"
    echo "$CHANGES" | tee -a "${LOG_FILE}"
else
    log "‚Ñπ –ù–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ" "${YELLOW}"
fi

log "üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π..." "${YELLOW}"
git pull origin main >> "${LOG_FILE}" 2>&1
check_status "Git pull –≤—ã–ø–æ–ª–Ω–µ–Ω"

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ package.json
log "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö..." "${YELLOW}"
if git diff HEAD@{1} HEAD -- package.json | grep -q .; then
    log "üì¶ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ package.json, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..." "${YELLOW}"
    npm install >> "${LOG_FILE}" 2>&1
    check_status "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    log "‚úì –ò–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ" "${GREEN}"
fi

# 6. –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Ç–µ–∫—É—â–µ–π —Å–±–æ—Ä–∫–∏
log "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Ç–µ–∫—É—â–µ–π —Å–±–æ—Ä–∫–∏..." "${YELLOW}"
if [ -d ".next" ]; then
    mv .next "${BACKUP_DIR}/.next.backup.$(date +%Y%m%d_%H%M%S)"
    check_status "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–±–æ—Ä–∫–∏ —Å–æ–∑–¥–∞–Ω–∞"
fi

# 7. –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
log "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..." "${YELLOW}"
npm run build >> "${LOG_FILE}" 2>&1
if [ $? -eq 0 ]; then
    check_status "–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
else
    log "‚úó –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ!" "${RED}"
    log "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å–±–æ—Ä–∫–∏..." "${YELLOW}"
    
    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±—ç–∫–∞–ø–∞
    LATEST_BACKUP=$(ls -t ${BACKUP_DIR}/.next.backup.* 2>/dev/null | head -n1)
    if [ -n "$LATEST_BACKUP" ]; then
        mv "$LATEST_BACKUP" .next
        log "‚úì –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å–±–æ—Ä–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞" "${GREEN}"
    fi
    
    log "‚ùå –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ —Å–±–æ—Ä–∫–∏" "${RED}"
    log "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ —Ñ–∞–π–ª: ${LOG_FILE}" "${YELLOW}"
    exit 1
fi

# 8. –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–ø—É—â–µ–Ω –ª–∏ PM2
log "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ PM2..." "${YELLOW}"
if command -v pm2 >/dev/null 2>&1; then
    PM2_STATUS=$(pm2 list | grep -c "${APP_NAME}")
    
    if [ "$PM2_STATUS" -gt 0 ]; then
        log "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ PM2..." "${YELLOW}"
        pm2 reload "${APP_NAME}" >> "${LOG_FILE}" 2>&1
        check_status "PM2 reload –≤—ã–ø–æ–ª–Ω–µ–Ω"
        
        # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
        sleep 3
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
        PM2_RUNNING=$(pm2 list | grep "${APP_NAME}" | grep -c "online")
        if [ "$PM2_RUNNING" -gt 0 ]; then
            log "‚úì –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ" "${GREEN}"
        else
            log "‚ö† –í–æ–∑–º–æ–∂–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–ø—É—Å–∫–æ–º, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ pm2 logs" "${YELLOW}"
        fi
    else
        log "‚ö† –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ PM2, –∑–∞–ø—É—Å–∫..." "${YELLOW}"
        pm2 start ecosystem.config.js >> "${LOG_FILE}" 2>&1
        check_status "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ PM2"
    fi
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PM2
    pm2 save >> "${LOG_FILE}" 2>&1
else
    log "‚ö† PM2 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é: npm start" "${YELLOW}"
fi

# 9. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
log "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..." "${YELLOW}"
sleep 2
if curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 | grep -q "200\|301\|302"; then
    log "‚úì –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã" "${GREEN}"
else
    log "‚ö† –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏" "${YELLOW}"
fi

# 10. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)
log "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤..." "${YELLOW}"
find "${BACKUP_DIR}" -type d -name ".next.backup.*" -mtime +7 -exec rm -rf {} \; 2>/dev/null
find "${BACKUP_DIR}" -type f -name ".env.production.backup.*" -mtime +7 -delete 2>/dev/null
check_status "–°—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã –æ—á–∏—â–µ–Ω—ã"

# 11. –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å PM2
if command -v pm2 >/dev/null 2>&1; then
    log "" "${NC}"
    log "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:" "${BLUE}"
    pm2 list | grep "${APP_NAME}" | tee -a "${LOG_FILE}"
    
    log "" "${NC}"
    log "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤:" "${BLUE}"
    pm2 logs "${APP_NAME}" --lines 20 --nostream | tee -a "${LOG_FILE}"
fi

# –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
echo "" | tee -a "${LOG_FILE}"
log "========================================" "${GREEN}"
log "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!" "${GREEN}"
log "========================================" "${GREEN}"
log "–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è: $(date)" "${BLUE}"
log "–õ–æ–≥ —Ñ–∞–π–ª: ${LOG_FILE}" "${BLUE}"
log "" "${NC}"
log "üìù –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:" "${YELLOW}"
log "  ‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:    pm2 logs ${APP_NAME}" "${NC}"
log "  ‚Ä¢ –°—Ç–∞—Ç—É—Å:            pm2 status" "${NC}"
log "  ‚Ä¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:        pm2 monit" "${NC}"
log "  ‚Ä¢ –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π:   git reset --hard ${CURRENT_COMMIT}" "${NC}"
echo "" | tee -a "${LOG_FILE}"

exit 0

